<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/card.css">
    <title>Home - Dynamic Cards</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/alpinejs/3.12.0/cdn.min.js" defer></script>
</head>

<body>
  <div x-data="homePage()" class="article-wrapper">
    <div class="cards-container" x-show="!loading">
      <template x-for="card in cards" :key="card.postId">
        <div class="article">
          <figure>
            <img :src="card.imagePatch" :alt="card.title" class="w-full h-48 object-cover" />
          </figure>
          <div class="article-body p-4">
            <span class="tag text-sm text-blue-600" x-text="card.tag"></span>
            <h2 class="text-xl font-bold mt-2" x-text="card.title"></h2>
            <p class="text-gray-700 mt-2" x-text="card.description"></p>
    
            <!-- Botão de Like -->
            <div x-data="{ liked: card.userLiked, likeCount: card.numberOfLikes }" class="like-button flex items-center mt-4">
              <button @click="toggleLike(card.postId, $event)" class="like flex items-center">
                <svg class="like-icon w-6 h-6" :class="{ 'liked': liked, 'text-red-500': liked, 'text-gray-500': !liked }" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                  <path d="m11.645 20.91-.007-.003-.022-.012a15.247 15.247 0 0 1-.383-.218 25.18 25.18 0 0 1-4.244-3.17C4.688 15.36 2.25 12.174 2.25 8.25 2.25 5.322 4.714 3 7.688 3A5.5 5.5 0 0 1 12 5.052 5.5 5.5 0 0 1 16.313 3c2.973 0 5.437 2.322 5.437 5.25 0 3.925-2.438 7.111-4.739 9.256a25.175 25.175 0 0 1-4.244 3.17 15.247 15.247 0 0 1-.383.219l-.022.012-.007.004-.003.001a.752.752 0 0 1-.704 0l-.003-.001Z"></path>
                </svg>
                <span class="like-text ml-2" x-text="liked ? 'Liked' : 'Like'"></span>
              </button>
              <span class="like-count ml-2 text-gray-600" x-text="likeCount"></span>
            </div>
            <!-- Fim do Botão de Like -->
    
            <!-- Ícone de Favorito (Estrela) -->
            <label class="container flex items-center mt-4">
              <input type="checkbox" class="hidden">
              <svg class="w-6 h-6 text-yellow-500 hover:text-yellow-600 cursor-pointer" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M9.362,9.158c0,0-3.16,0.35-5.268,0.584c-0.19,0.023-0.358,0.15-0.421,0.343s0,0.394,0.14,0.521    c1.566,1.429,3.919,3.569,3.919,3.569c-0.002,0-0.646,3.113-1.074,5.19c-0.036,0.188,0.032,0.387,0.196,0.506    c0.163,0.119,0.373,0.121,0.538,0.028c1.844-1.048,4.606-2.624,4.606-2.624s2.763,1.576,4.604,2.625    c0.168,0.092,0.378,0.09,0.541-0.029c0.164-0.119,0.232-0.318,0.195-0.505c-0.428-2.078-1.071-5.191-1.071-5.191    s2.353-2.14,3.919-3.566c0.14-0.131,0.202-0.332,0.14-0.524s-0.23-0.319-0.42-0.341c-2.108-0.236-5.269-0.586-5.269-0.586    s-1.31-2.898-2.183-4.83c-0.082-0.173-0.254-0.294-0.456-0.294s-0.375,0.122-0.453,0.294C10.671,6.26,9.362,9.158,9.362,9.158z"></path>
              </svg>
            </label>
            <!-- Fim do Ícone de Favorito -->
          </div>
        </div>
      </template>
    </div>
    <div x-show="loading" class="loading">Loading...</div>
  </div>
  
  <script>
    function homePage() {
      return {
        cards: [], // Armazena os cards
        loading: true, // Controla o estado de carregamento
        
        async fetchCards() {
          try {
            // Requisição GET para buscar os cards
            const token = localStorage.getItem('token'); // Recupera o token JWT
            const response = await fetch("http://localhost:9090/apiV1/home", {
            });
            const data = await response.json();
            
            this.cards = data; // Atualiza a lista de cards com a resposta
          } catch (error) {
            console.error("Error fetching cards:", error);
          } finally {
            this.loading = false; // Finaliza o carregamento
          }
        },

        async toggleLike(postId, event) {
          if (!event || !event.target) {
            console.error("Evento ou event.target está indefinido!");
            return;
          }

          const likeButton = event.target.closest('.like-button');
          if (!likeButton) {
            console.error("Botão de like não encontrado!");
            return;
          }

          const likeCountElement = likeButton.querySelector('.like-count');
          const likeTextElement = likeButton.querySelector('.like-text');
          console.log(likeCountElement, likeTextElement); // Verifique se os elementos existem

          try {
            const token = localStorage.getItem('jwtToken'); // Recupera o token JWT
            const response = await fetch(`http://localhost:9090/apiV1/like`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}` // Envia o token no cabeçalho
              },
              body: JSON.stringify({ postId: postId }) // Envia o postId no corpo da requisição
            });

            if (response.ok) {
              const updatedCard = await response.json();
              console.log('Resposta recebida:', updatedCard);

              // Acesse o postId da resposta, caso necessário
              const updatedPost = updatedCard.postId; // O objeto 'updatedCard' possui o postId, se necessário

              // Encontre o índice do card no array
              const cardIndex = this.cards.findIndex(card => card.postId === postId);
              
              if (cardIndex !== -1) {
                // Atualiza o estado do like e o número de likes no card
                this.cards[cardIndex].userLiked = updatedCard.userLiked;  // Atualiza se o usuário deu like
                this.cards[cardIndex].numberOfLikes = updatedCard.numberOfLikes;  // Atualiza o número de likes

                // Atualiza o DOM diretamente através da variável reativa
                likeCountElement.textContent = updatedCard.numberOfLikes; // Atualiza a contagem de likes exibida
              } else {
                console.error("Card não encontrado para o postId:", postId);
              }
            } else {
              console.error("Erro ao alternar like:", response.statusText);
            }
          } catch (error) {
            console.error("Error toggling like:", error);
          }
        },

        init() {
          this.fetchCards(); // Carrega os cards ao inicializar
        },
      };
    }
  </script>
</body>
</html>

